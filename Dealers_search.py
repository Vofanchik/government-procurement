icon = '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'
import tkinter
from tkinter import *
from tkinter import ttk
from tkinter.ttk import Combobox
from tkinter import messagebox

import pyperclip
import requests
from bs4 import BeautifulSoup


def get_item_name():
    try:

        region = combo.get()

        if region == 'Москва':
            region = int(77)
        elif region == 'Свердловская область':
            region = int(66)
        elif region == 'Россия':
            region = ''

        # search_window.delete("1.0", "end")
        prodsearch = txt.get()


        payloads_ = {f'customerregion': region, 'perpage': {combo_1.get()}, 'currentstage': 'EC', 'sort': '-signDate'}
        response = requests.get(f"http://openapi.clearspending.ru/restapi/v3/contracts/search/?productsearch={prodsearch}",
                                params=payloads_)
        all_info = []
        names_of = []
        emails_of = []
        prods_of = []
        urls_of = []
        phone_of = []
        for contracts in response.json()['contracts']['data']:
            # prg_bar.step(10)

            try:

                org_name = contracts['suppliers'][0]['organizationName']
                if org_name not in names_of:
                    names_of.append(org_name)
                else:
                    continue
            except:
                continue
            regnum = contracts['regNum']

            payload = {'contractReestrNumber': regnum}
            headers = {
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36'}
            response_2 = requests.get('https://zakupki.gov.ru/epz/contract/printForm/view.html?', params=payload,
                                      headers=headers)
            response_2.encoding = 'utf-8'
            # org_email = str(re.findall(r'[\w\.-]+@[\w\.-]+', response_2.text)).replace('[', '').replace(']', '')
            contract_url = contracts['contractUrl']
            # print(contract_url)
            soup = BeautifulSoup(response_2.text, 'html.parser')
            phone_email = soup.select("body > div > div > table:nth-last-of-type(4) > tr:nth-child(4)")

            soup = BeautifulSoup(str(phone_email), 'html.parser')
            # print(contract_url)
            phone_email = str(soup.find_all('td')[11].get_text()).split(' ')
            phone_email = list(filter(lambda a: a != '', phone_email))
            phone = phone_email[0]
            email = phone_email[-1]
            urls_of.append(contract_url)
            emails_of.append(email)
            phone_of.append(phone)
            products_list = []
            for itera, products in enumerate(contracts['products']):
                products_list.append(products['name'])
                if itera == 0:
                    break
            prods_of.append(str(products_list).replace('[\'', '').replace('\']', ''))
        down_space = '_' * 10

        names_of_fin = [elem.replace('ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ', 'ООО').replace('Общество с ограниченной ответственностью', 'ООО').replace('ЗАКРЫТОЕ АКЦИОНЕРНОЕ ОБЩЕСТВО', 'ЗАО') for elem in names_of]

        all_info.append(list(zip(names_of_fin,emails_of,phone_of, prods_of))) #, down_space
        # print(all_info)
        [tree.insert('', 'end', values=row) for row in all_info[0]]
        # pretty_view = pformat(all_info).replace('[', '').replace(']', '').replace('\'', '').replace(',', '').replace('(', '').replace(')', '')
        # print(pretty_view)
        # search_window.insert(INSERT, (pretty_view))
    except:
        messagebox.showerror('Ошибка', 'Попробуйте другой запрос')


def copy_org():
    pyperclip.copy(selected_row_org())


def selected_row_org():
    return tree.set(tree.selection(), '#1')


def copy_mail():
    pyperclip.copy(selected_row_mail())

def selected_row_mail():
    return tree.set(tree.selection(), '#2')

window = Tk()
window.geometry('620x540')
window.title("Поиск поставщиков")
window.resizable(width=False, height=False)


lbl = Label(window, text="Введите наименование товара", font=("Arial Bold", 14))
lbl.pack()

txt = Entry(window, width=100, borderwidth=5)
txt.focus()
txt.pack()

lbl2 = Label(window, text="Выберите регион поиска", font=("Arial Bold", 14))
lbl2.pack()

combo = Combobox(window)
combo['values'] = ('Свердловская область', 'Москва', 'Россия')
combo.current(0)
combo.pack()

lbl3 = Label(window, text="Выберите количество запросов", font=("Arial Bold", 14))
lbl3.pack()

combo_1 = Combobox(window)
combo_1['values'] = ('1', '5', '10', '20')
combo_1.current(0)
combo_1.pack()

btn_search = Button(window, text='Поиск', command=get_item_name, bd = 3, bg='cyan', padx=230)
btn_search.pack()


tree = ttk.Treeview(columns=('organization', 'email', 'phone', 'items'), height=15, show='headings')


tree.column('organization', width=200)  # , stretch="no"
tree.column('email', width=100)
tree.column('phone', width=100)
tree.column('items', width=300)

tree.heading('organization', text='Организация')
tree.heading('email', text='Почта')
tree.heading('phone', text='Телефон')
tree.heading('items', text='Объект закупки')

tree.pack()

btn_copy_org = Button(window, text='Копировать организацию в буфер', command=copy_org, bd=5)
btn_copy_org.pack(side=tkinter.LEFT) #side=tkinter.LEFT

btn_copy_mail = Button(window, text='Копировать почту в буфер', command=copy_mail, bd=5)
btn_copy_mail.pack(side=tkinter.LEFT) #side=tkinter.LEFT

window.iconphoto(True, tkinter.PhotoImage(data=icon))
window.mainloop()